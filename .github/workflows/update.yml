import pandas as pd
import numpy as np
import yfinance as yf
import json
import os
from datetime import datetime, timezone

START_DATE = "2000-01-01"
OUTPUT_CSV = "docs/data/trades.csv"
OUTPUT_JSON = "docs/data/status.json"
OUTPUT_EQUITY = "docs/data/equity.csv"

os.makedirs("docs/data", exist_ok=True)


def log(msg):
    print(f"[*] {msg}")


def cast_float(x):
    try:
        return float(x)
    except:
        return x


def load_ftsemib():
    log("Download FTSEMIB.MI…")
    df = yf.download("FTSEMIB.MI", start=START_DATE, interval="1d",
                     auto_adjust=False, progress=False)

    if df is None or df.empty:
        raise ValueError("Yahoo Finance returned empty data.")

    df = df[["Open", "High", "Low", "Close", "Volume"]].copy()
    df.index = pd.to_datetime(df.index)
    df.index.name = "Date"
    return df


def build_dataset():
    df = load_ftsemib()
    log(f"Rows: {len(df)}")

    df["Close_prev"] = df["Close"].shift(1)
    df["gap_open"] = df["Open"] / df["Close_prev"] - 1

    df["vol_ma"] = df["Volume"].rolling(20).mean()
    df["vol_std"] = df["Volume"].rolling(20).std()
    df["vol_z"] = (df["Volume"] - df["vol_ma"]) / df["vol_std"]

    df.dropna(inplace=True)
    return df


def compute_signal(row):
    if row["gap_open"] > -0.002 and row["vol_z"] < -0.5:
        return 1
    if row["gap_open"] < -0.01 and row["vol_z"] > 1.5:
        return -1
    return 0


def run_backtest(df):
    log("Running backtest…")

    df["Signal"] = df.apply(compute_signal, axis=1)
    df["Next_Open"] = df["Open"].shift(-1)
    df["Return"] = (df["Next_Open"] / df["Open"] - 1) * df["Signal"]
    df = df[:-1]

    trades = df[df["Signal"] != 0].copy()

    # FIX DEFINITIVO — NO "dt" — SOLO row.name
    trades_list = []
    for idx, row in trades.iterrows():
        date_str = idx.strftime("%Y-%m-%d")

        trades_list.append({
            "date": date_str,
            "signal": int(row["Signal"]),
            "return_pct": cast_float(row["Return"] * 100)
        })

    equity = (1 + trades["Return"]).cumprod()
    equity_df = pd.DataFrame({"Date": equity.index, "Equity": equity.values})
    equity_df.to_csv(OUTPUT_EQUITY, index=False)

    return trades, trades_list, equity_df


def save_results(trades, trades_list, equity):
    log("Saving JSON + CSV…")

    trades.to_csv(OUTPUT_CSV)

    out = {
        "timestamp_utc": datetime.now(timezone.utc).strftime("%Y-%m-%d %H:%M:%S UTC"),
        "num_trades": int(len(trades)),
        "avg_return_pct": cast_float(trades["Return"].mean() * 100),
        "winrate": cast_float((trades["Return"] > 0).mean() * 100),
        "last_signal": int(trades["Signal"].iloc[-1]) if len(trades) else 0,
        "trades": trades_list
    }

    with open(OUTPUT_JSON, "w") as f:
        json.dump(out, f, indent=2)


def compute_all():
    log("Starting computation…")
    df = build_dataset()
    trades, trades_list, equity = run_backtest(df)
    save_results(trades, trades_list, equity)
    log("Done.")


if __name__ == "__main__":
    compute_all()
